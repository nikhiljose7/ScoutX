{% extends "base.html" %}

{% block title %}Undervalued Players - Football Analytics{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Undervalued Players</h2>
    <p>Players with predicted value higher than their current market value</p>
</div>

<div class="card">
    <div class="card-header">Filter Options</div>
    <form id="filterForm">
        <div class="form-group">
            <label for="position">Position</label>
            <select id="position" class="form-control">
                <option value="ALL">All Positions</option>
                <option value="FW">Forward (FW)</option>
                <option value="MF">Midfielder (MF)</option>
                <option value="DF">Defender (DF)</option>
                <option value="GK">Goalkeeper (GK)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="topN">Number of Results</label>
            <select id="topN" class="form-control">
                <option value="10">Top 10</option>
                <option value="25" selected>Top 25</option>
                <option value="50">Top 50</option>
                <option value="100">Top 100</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</div>

<div id="resultsSection" class="hidden">
    <div class="card">
        <div class="card-header">Results</div>
        <div id="loadingMessage" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>Loading results...</p>
        </div>
        <div id="errorMessage" class="message message-error hidden"></div>
        <div class="table-container">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Position</th>
                        <th>Squad</th>
                        <th>League</th>
                        <th>Age</th>
                        <th>Market Value (€M)</th>
                        <th>Predicted Value (€M)</th>
                        <th>Undervaluation (€M)</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('filterForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const position = document.getElementById('position').value;
    const topN = parseInt(document.getElementById('topN').value);
    
    const resultsSection = document.getElementById('resultsSection');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const resultsBody = document.getElementById('resultsBody');
    
    resultsSection.classList.remove('hidden');
    loadingMessage.classList.remove('hidden');
    errorMessage.classList.add('hidden');
    resultsBody.innerHTML = '';
    
    try {
        const response = await fetch('/api/undervalued', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ position, top_n: topN })
        });
        
        const result = await response.json();
        loadingMessage.classList.add('hidden');
        
        if (result.success) {
            result.data.forEach((player, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.Player}</td>
                    <td>${player.Main_Pos}</td>
                    <td>${player.Squad}</td>
                    <td>${player.Comp}</td>
                    <td>${Math.round(player.Age)}</td>
                    <td>${player.Market_Value_Million_EUR.toFixed(2)}</td>
                    <td>${player.Predicted_Value.toFixed(2)}</td>
                    <td>${player.Undervaluation.toFixed(2)}</td>
                `;
                resultsBody.appendChild(row);
            });
        } else {
            errorMessage.textContent = 'Error: ' + result.error;
            errorMessage.classList.remove('hidden');
        }
    } catch (error) {
        loadingMessage.classList.add('hidden');
        errorMessage.textContent = 'Error loading results. Please try again.';
        errorMessage.classList.remove('hidden');
    }
});
</script>
{% endblock %}